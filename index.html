<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Beehive Construction Simulator — v3</title>
  <style>
    /* ===== Design tokens ===== */
    :root{
      --bg:#0b0f14; --panel:#111826; --ink:#cfe8ff; --ink-dim:#96a7be;
      --wax:#ffe9a6; --wax-line:#f7d878;
      --honey:#f4a259; --honey-deep:#cc7717;
      --pollen:#ffd54a; --pollen-deep:#e4a500;
      --brood:#ffb7a6; --bee:#ffd100; --bee-2:#ffb000;
      --accent:#5eead4; --vh:1vh;
    }

    /* ===== Base layout ===== */
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#0a0f15,#0b0f14 20%,#0a0e12);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{display:grid;grid-template-columns:320px 1fr;height:100dvh}
    .panel{background:var(--panel);padding:18px 16px 14px;border-right:1px solid #0f1623;box-shadow:inset -1px 0 0 #0a111d}
    h1{font-size:20px;margin:0 0 10px;letter-spacing:.3px}
    p{color:var(--ink-dim);margin:.25rem 0 .75rem}
    .ctrl{margin:12px 0 18px}
    .ctrl label{display:flex;justify-content:space-between;font-size:13px;color:var(--ink-dim)}
    .ctrl input[type=range]{width:100%;height:34px}
    .row{display:flex;gap:10px;margin-top:10px}
    .btn{flex:1;background:#0f1728;border:1px solid #2b3f65;color:var(--ink);padding:14px 14px;border-radius:14px;cursor:pointer;font-weight:600;letter-spacing:.2px;box-shadow:0 4px 16px rgba(0,0,0,.25)}
    .btn:hover{border-color:#5b86d8;transform:translateY(-1px);box-shadow:0 8px 22px rgba(0,0,0,.35)}
    .btn:active{transform:translateY(0)}
    .btn--primary{background:linear-gradient(180deg,#1b2a44,#132036);border-color:#6be8d8;outline:2px solid rgba(94,234,212,.35)}
    .legend{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:10px}
    .key{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--ink-dim)}
    .sw{width:16px;height:12px;border-radius:3px;border:1px solid #29364e}
    .stat{font-size:12px;color:var(--ink-dim);display:grid;grid-template-columns:1fr auto;gap:4px;margin-top:6px}
    .number{font-variant-numeric:tabular-nums}

    .canvas-wrap{position:relative}
    canvas{display:block;width:100%;height:100%}
    .overlay{position:absolute;left:10px;top:10px;background:rgba(9,14,22,.5);backdrop-filter:blur(4px);padding:8px 10px;border-radius:10px;border:1px solid #18253c;font-size:12px;color:var(--ink-dim);z-index:5}
    .overlay b{color:var(--ink)}
    .footer{position:absolute;left:0;right:0;bottom:8px;text-align:center;color:#70839c;font-size:12px}

    /* ===== Mobile: 60/40 + collapsible panel + floating toggle ===== */
    @media (max-width: 860px){
      .wrap{ grid-template-columns: 1fr; grid-template-rows: 40dvh 1fr; height: 100dvh; }
      .panel{ border-right:none; border-bottom:1px solid #0f1623; max-height:40dvh; overflow:auto; }
      .mobile-bar{ display:flex; gap:8px; align-items:center; margin:-6px 0 10px; }
      .mobile-toggle{ background:#0f1728; border:1px solid #2b3f65; color:var(--ink); padding:8px 10px; border-radius:10px; font-size:14px; }
      body.panel-collapsed .panel{ display:none; }
      body.panel-collapsed .wrap{ grid-template-rows: 0 1fr; }
      body.panel-collapsed .fab-toggle{ display:inline-flex; }
    }
    .fab-toggle{ position:fixed; right:10px; top:10px; z-index:10; display:none; background:#0f1728; border:1px solid #2b3f65; color:var(--ink); padding:10px 12px; border-radius:12px; font-size:14px; }

    /* iOS fallback if 100dvh unsupported */
    @supports not (height: 100dvh){ .wrap{ height: calc(var(--vh) * 100); } }
  </style>
</head>
<body>
  <button class="fab-toggle" id="togglePanelFloating" aria-label="Show controls">☰ Show controls</button>
  <div class="wrap">
    <aside class="panel">
      <div class="mobile-bar" aria-hidden="true">
        <button class="mobile-toggle" id="togglePanel">☰ Hide controls</button>
        <span style="color:#90a4c3;font-size:12px">(tap to maximize canvas)</span>
      </div>
      <h1>Beehive Construction Simulator — v3</h1>
      <p>Brood core → pollen ring → honey outer. Adjust colony size and resources to influence growth and storage dynamics.</p>

      <div class="ctrl">
        <label>Colony size <span><span id="beeCountOut" class="number">160</span> bees</span></label>
        <input id="beeCount" type="range" min="10" max="800" value="160" />
      </div>
      <div class="ctrl">
        <label>Resource availability <span><span id="resourceOut">1.00×</span></span></label>
        <input id="resource" type="range" min="0" max="200" value="100" />
      </div>
      <div class="row">
        <button class="btn btn--primary" id="pauseBtn">Pause</button>
        <button class="btn btn--primary" id="resetBtn">Reset</button>
      </div>

      <div class="legend">
        <div class="key"><span class="sw" style="background:var(--wax)"></span>Built wax cell</div>
        <div class="key"><span class="sw" style="background:var(--brood)"></span>Brood (eggs/larvae)</div>
        <div class="key"><span class="sw" style="background:linear-gradient(180deg,var(--pollen),var(--pollen-deep))"></span>Pollen stores</div>
        <div class="key"><span class="sw" style="background:linear-gradient(180deg,var(--honey),var(--honey-deep))"></span>Honey stored</div>
        <div class="key"><span class="sw" style="background:radial-gradient(circle at 50% 50%, var(--bee), var(--bee-2))"></span>Worker bee</div>
      </div>

      <div class="stat" id="stats">
        <span>Wax cells built</span><span id="cellsBuilt" class="number">0</span>
        <span>Cells with brood</span><span id="cellsBrood" class="number">0</span>
        <span>Cells with pollen</span><span id="cellsPollen" class="number">0</span>
        <span>Cells with honey</span><span id="cellsHoney" class="number">0</span>
      </div>

      <p style="margin-top:12px">Tip: Collapse the controls on phones (☰) for full-screen comb.</p>
    </aside>

    <main class="canvas-wrap">
      <canvas id="c"></canvas>
      <div class="overlay">Comb radius: <b id="radiusOut">—</b> · FPS: <b id="fps">—</b></div>
      <div class="footer">© Beehive model (simplified): random walk + local attachment + spatial brood/pollen preference.</div>
    </main>
  </div>

  <script>
  ;(() => {
    /* =========================
       v3 — clean modular architecture
       - Layout: size, center, collapse + center delta
       - Grid: axial-only comb
       - Renderer: pure draw
       - Controller: UI + tick
       - Patch: recenter bees & trails by exact delta on any layout change
    ========================== */

    // ===== Layout Manager =====
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));

    function setVH(){ const vh = window.innerHeight * 0.01; document.documentElement.style.setProperty('--vh', `${vh}px`); }
    setVH(); window.addEventListener('resize', setVH);

    const layout = {
      W:0,H:0,cx:0,cy:0, prevCx:undefined, prevCy:undefined,
      resize(){
        const rect = canvas.parentElement.getBoundingClientRect();
        this.W = Math.floor(rect.width);
        this.H = Math.floor(rect.height);
        this.prevCx = this.cx; this.prevCy = this.cy;
        this.cx = this.W/2; this.cy = this.H/2;
        canvas.width = Math.floor(this.W * DPR);
        canvas.height = Math.floor(this.H * DPR);
        canvas.style.width = this.W + 'px';
        canvas.style.height = this.H + 'px';
        ctx.setTransform(DPR,0,0,DPR,0,0);
        const dx = (isFinite(this.prevCx) ? this.cx - this.prevCx : 0);
        const dy = (isFinite(this.prevCy) ? this.cy - this.prevCy : 0);
        return {dx,dy};
      }
    };

    // mobile collapse controls
    const toggleBtn = document.getElementById('togglePanel');
    const toggleFab = document.getElementById('togglePanelFloating');
    function togglePanel(){
      const collapsed = document.body.classList.toggle('panel-collapsed');
      if(toggleBtn) toggleBtn.textContent = collapsed ? '☰ Show controls' : '☰ Hide controls';
      if(toggleFab) toggleFab.setAttribute('aria-label', collapsed ? 'Show controls' : 'Hide controls');
      const {dx,dy} = layout.resize();
      recenterBees(dx,dy);
    }
    toggleBtn && toggleBtn.addEventListener('click', togglePanel);
    toggleFab && toggleFab.addEventListener('click', togglePanel);

    // ===== Grid (axial) =====
    const HEX_SIZE = 14;
    const sqrt3 = Math.sqrt(3);
    const HEX_W = HEX_SIZE * 2;
    const HEX_H = sqrt3 * HEX_SIZE;
    const HEX_HORIZ = 1.5 * HEX_SIZE;

    const grid = [];
    const gridMap = new Map();
    const key = (q,r) => q+','+r;
    const hexDistance = (q,r) => (Math.abs(q)+Math.abs(r)+Math.abs(q+r))/2;
    const axialToPixel = (q,r,cx,cy) => ({ x: cx + (q*HEX_HORIZ), y: cy + (r*HEX_H + (q*HEX_H)/2) });

    function buildGrid(W,H){
      grid.length = 0; gridMap.clear();
      const radius = Math.floor(Math.min(W,H)/(HEX_W*0.9));
      const R = Math.max(8, Math.floor(radius));
      for(let q=-R;q<=R;q++){
        for(let r=Math.max(-R,-q-R); r<=Math.min(R,-q+R); r++){
          const c = { q, r, built:false, honey:0, pollen:0, brood:0, dist: hexDistance(q,r) };
          gridMap.set(key(q,r), c); grid.push(c);
        }
      }
      const center = gridMap.get(key(0,0));
      center.built = true;
      return R;
    }

    const neighbors = (q,r) => [ [q+1,r],[q-1,r],[q,r+1],[q,r-1],[q+1,r-1],[q-1,r+1] ];
    const get = (q,r) => gridMap.get(key(q,r));
    function ensureNeighbors(c){
      for(const [qq,rr] of neighbors(c.q,c.r)) if(!get(qq,rr)){
        const nc = { q:qq, r:rr, built:false, honey:0, pollen:0, brood:0, dist: hexDistance(qq,rr) };
        gridMap.set(key(qq,rr), nc); grid.push(nc);
      }
    }

    // ===== Params =====
    const params = {
      bees: 160,
      resMul: 1.0,
      buildBase: 0.0018,
      honeyFill: 0.002,
      broodRate: 0.004,
      pollenRate: 0.003,
      broodR: 6,
      pollenIn: 7,
      pollenOut: 11,
      seedJump: 0.002,
      trailLen: 15
    };

    // ===== Agents =====
    const bees = [];
    function spawnBees(n){
      bees.length = 0;
      const c = get(0,0);
      const cc = axialToPixel(0,0,layout.cx,layout.cy);
      for(let i=0;i<n;i++){
        bees.push({ cell:c, x:cc.x+(Math.random()-0.5)*4, y:cc.y+(Math.random()-0.5)*4, hx:[cc.x], hy:[cc.y], speed:0.6+Math.random()*0.6, target:null });
      }
    }
    function recenterBees(dx,dy){ if(!dx && !dy) return; for(const b of bees){ b.x+=dx; b.y+=dy; for(let i=0;i<b.hx.length;i++){ b.hx[i]+=dx; b.hy[i]+=dy; } } }
    function pickNextCell(c){ ensureNeighbors(c); const ns = neighbors(c.q,c.r).map(([q,r])=>get(q,r)); const choices=[]; for(const n of ns){ const base=1,bias=n?.built?5:1,edge=Math.max(0,1-(n?.honey||0)); const w=base+bias+edge; for(let k=0;k<w;k++) choices.push(n); } return choices[(Math.random()*choices.length)|0]||c; }

    // ===== UI Controller =====
    const beeCountEl = document.getElementById('beeCount');
    const beeCountOut = document.getElementById('beeCountOut');
    const resourceEl = document.getElementById('resource');
    const resourceOut = document.getElementById('resourceOut');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const cellsBuiltEl = document.getElementById('cellsBuilt');
    const cellsHoneyEl = document.getElementById('cellsHoney');
    const cellsPollenEl = document.getElementById('cellsPollen');
    const cellsBroodEl = document.getElementById('cellsBrood');
    const radiusOut = document.getElementById('radiusOut');
    const fpsEl = document.getElementById('fps');

    let running = true, last = performance.now(), fpsAvg = 0;

    function applySliders(){ params.bees=parseInt(beeCountEl.value,10); beeCountOut.textContent=params.bees; params.resMul=resourceEl.value/100; resourceOut.textContent=params.resMul.toFixed(2)+'×'; }

    beeCountEl.addEventListener('input',()=>{
      const desired = parseInt(beeCountEl.value,10); const diff = desired - bees.length; beeCountOut.textContent = desired;
      if(diff>0){ const c=get(0,0); const cc=axialToPixel(0,0,layout.cx,layout.cy); for(let i=0;i<diff;i++) bees.push({cell:c,x:cc.x,y:cc.y,hx:[cc.x],hy:[cc.y],speed:0.6+Math.random()*0.6,target:null}); }
      else if(diff<0){ bees.length = desired; }
    });
    resourceEl.addEventListener('input',()=>{ params.resMul = resourceEl.value/100; resourceOut.textContent = params.resMul.toFixed(2)+'×'; });
    pauseBtn.addEventListener('click',()=>{ running = !running; pauseBtn.textContent = running? 'Pause':'Resume'; });
    resetBtn.addEventListener('click',()=>{ init(true); });

    // ===== Simulation update =====
    function update(dt){
      const buildRate=params.buildBase*params.resMul, fillRate=params.honeyFill*params.resMul, broodRate=params.broodRate*params.resMul, pollenRate=params.pollenRate*params.resMul;
      if(Math.random()<params.seedJump*params.resMul){ const built=grid.filter(c=>c.built); if(built.length){ const seed=built[(Math.random()*built.length)|0]; ensureNeighbors(seed); for(const [q,r] of neighbors(seed.q,seed.r)){ const n=get(q,r); if(n && !n.built && Math.random()<0.2) n.built=true; } } }
      for(const b of bees){ if(!b.target||Math.random()<0.02) b.target=pickNextCell(b.cell);
        const tp=axialToPixel(b.target.q,b.target.r,layout.cx,layout.cy); const tx=tp.x+(Math.random()-0.5)*2, ty=tp.y+(Math.random()-0.5)*2;
        const dx=tx-b.x, dy=ty-b.y, dist=Math.hypot(dx,dy)+1e-6, step=Math.min(dist,b.speed*dt*60);
        b.x+=dx/dist*step; b.y+=dy/dist*step; b.hx.push(b.x); b.hy.push(b.y); if(b.hx.length>params.trailLen){ b.hx.shift(); b.hy.shift(); }
        if(dist<2.5){ const c=b.target; b.cell=c; if(!c.built){ if(Math.random()<buildRate*dt*60) c.built=true; }
          else if(c.dist<=params.broodR){ if(Math.random()<broodRate*dt*60){ c.brood=Math.min(1,c.brood+0.08*Math.random()); c.honey=0; c.pollen=0; } }
          else if(c.dist>params.pollenIn && c.dist<=params.pollenOut){ if(Math.random()<pollenRate*dt*60){ c.pollen=Math.min(1,c.pollen+0.08*Math.random()); if(c.pollen>0.2){ c.honey=0; c.brood=0; } } }
          else { if(Math.random()<fillRate*dt*60){ c.honey=Math.min(1,c.honey+0.05*Math.random()); if(c.honey>0.2){ c.pollen=0; c.brood=0; } } } }
      }
    }

    // ===== Renderer =====
    function drawHex(x,y,fill,stroke){ const a=(Math.PI/180)*30; ctx.beginPath(); for(let i=0;i<6;i++){ const ang=a+i*Math.PI/3; const px=x+HEX_SIZE*Math.cos(ang); const py=y+HEX_SIZE*Math.sin(ang); if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);} ctx.closePath(); if(fill){ ctx.fillStyle=fill; ctx.fill(); } ctx.lineWidth=1*DPR; ctx.strokeStyle=stroke||'rgba(255,255,255,0.08)'; ctx.stroke(); }
    function render(){
      ctx.clearRect(0,0,layout.W,layout.H);
      for(const c of grid){ const p=axialToPixel(c.q,c.r,layout.cx,layout.cy); const x=p.x,y=p.y; if(x<-HEX_W||x>layout.W+HEX_W||y<-HEX_H||y>layout.H+HEX_H) continue; if(c.built){ drawHex(x,y,'rgba(255,233,166,0.9)','rgba(247,216,120,0.8)'); if(c.brood>0){ const a=0.35+0.55*c.brood; drawHex(x,y,`rgba(255,183,166,${a})`,'rgba(255,210,210,0.9)'); } if(c.pollen>0&&c.brood===0){ const gP=ctx.createLinearGradient(x-HEX_SIZE,y-HEX_SIZE,x+HEX_SIZE,y+HEX_SIZE); gP.addColorStop(0,`rgba(255,213,74,${0.25+0.5*c.pollen})`); gP.addColorStop(1,`rgba(228,165,0,${0.35+0.5*c.pollen})`); drawHex(x,y,gP,'rgba(255,220,120,0.9)'); } if(c.honey>0&&c.brood===0&&c.pollen===0){ const g=ctx.createLinearGradient(x,y-HEX_SIZE,x,y+HEX_SIZE); g.addColorStop(0,'rgba(244,162,89,'+(0.35+0.45*c.honey)+')'); g.addColorStop(1,'rgba(204,119,23,'+(0.45+0.45*c.honey)+')'); drawHex(x,y,g,'rgba(255,210,110,0.9)'); } } else { drawHex(x,y,null,'rgba(255,255,255,0.05)'); } }
      ctx.lineWidth=1.5*DPR; ctx.lineCap='round';
      for(const b of bees){ ctx.beginPath(); for(let i=0;i<b.hx.length;i++){ const t=i/(b.hx.length-1); const alpha=t*0.35; if(i>0){ ctx.strokeStyle=`rgba(255,209,0,${alpha})`; ctx.moveTo(b.hx[i-1],b.hy[i-1]); ctx.lineTo(b.hx[i],b.hy[i]); ctx.stroke(); } } }
      for(const b of bees){ const grd=ctx.createRadialGradient(b.x,b.y,0,b.x,b.y,4*DPR); grd.addColorStop(0,'rgba(255,209,0,1)'); grd.addColorStop(1,'rgba(255,176,0,0.1)'); ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(b.x,b.y,3.2*DPR,0,Math.PI*2); ctx.fill(); }
    }

    // ===== Stats & Game Loop =====
    function updateStats(){ let built=0,honey=0,pollen=0,brood=0; for(const c of grid){ if(c.built) built++; if(c.honey>0.02) honey++; if(c.pollen>0.02) pollen++; if(c.brood>0.02) brood++; } cellsBuiltEl.textContent=built; cellsHoneyEl.textContent=honey; cellsPollenEl.textContent=pollen; cellsBroodEl.textContent=brood; }
    let running=true,last=performance.now(),fpsAvg=0;
    function frame(t){ const dt=Math.min(0.05,(t-last)/1000); last=t; if(running){ update(dt); updateStats(); } render(); const fps=1/Math.max(1e-6,dt); fpsAvg=fpsAvg*0.9+fps*0.1; fpsEl.textContent=fps.toFixed(0); requestAnimationFrame(frame); }

    // ===== Init & resize hooks =====
    function init(resetAll=false){ const {dx,dy}=layout.resize(); if(resetAll){ buildGrid(layout.W,layout.H); spawnBees(params.bees); } radiusOut.textContent = Math.max(8, Math.floor(Math.min(layout.W,layout.H)/(HEX_W*0.9))) + ' cells'; applySliders(); recenterBees(dx,dy); }
    window.addEventListener('resize', ()=>{ const {dx,dy}=layout.resize(); recenterBees(dx,dy); });

    init(true); requestAnimationFrame(frame);
  })();
  </script>
</body>
</html>
